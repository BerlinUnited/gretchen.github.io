# Motor Control

The actuator of the Gretchen robot can be controlled by the software libraries which run on **an external computer with Linux OS**. This introduces a **significant delay in the control loop** because at each time step the motors send commands with their current state to the computer and wait for it to recalculate the data and send the new commands back. In order to minimize the feedback delay between the computer and the servos, it’s important to **set the low-latency mode** on the computer. However, the low latency mode doesn’t eliminate the feedback delay completely. The movements of the robot are generated by changing the speed and the rotation of the actuators, which are determined by the current and its direction respectively. Conventional microcontrollers can’t pass enough current or voltage for powering a motor, therefore specialized circuits have been developed to supply motors with power and **protect the microcontrollers from additional electrical problems**, one of the being the **H-bridge**.

## H-Bridge

An **H-bridge** is a widely used circuit for powering DC motors, which uses **4 switches** for managing the **direction and the speed of a motor**. The ’H’ signifies the shape of the circuit, as the four switches are placed pairwise in series and in parallel, with the motor placed in the middle. The Sensorimotor boards have an integrated H-Bridge which receives as input **a PWM and a direction signal** and can handle up to 6A.

## Controllers

Calculating the input values for the H-Bridge is not a trivial task and there are several approaches for controlling the motors, the most common ones being **position, velocity and torque control**. The position control mechanism is easy for humans to comprehend because the position is a physical variable more commonly used in the real world than torque or velocity. **Torque control** is a method of moving the actuators by working with **voltage and the current**, instead of the position. **Velocity control**, as the name suggests, calculates the speed of the motor by **comparing the desired velocity with the measured velocity**. Due to the open-source nature of the Gretchen robot, it allows a big room for experiments and for trying out alternative controllers. For instance, the Libsensorimotor repository contains the implementation of a **Cognitive Sensorimotor Loop (CSL)** controller, which is a novel, computationally simplistic, and energy-efficient approach of making a humanoid robot to stand up from various postures. It does not require any additional sensors - **the motor itself serves both as actuator and sensor**.

### PID Controller

The Libsensorimotor repository contains the C++ implementation of a **position control mechanism**, namely, the **proportional-integral-derivative (PID) controller**. The motors are sending their position to the computer, where the PID controller calculates the next position and sends it back to each of the motors at **a rate of 100Hz** until the
desired positions are achieved. A PID controller is the **most commonly used control loop mechanism** due to its **simple
implementation, clear functionality, and a wide range of applications**. Its transfer function is shown below


<figure>
  <img src="../img_gretchen/pid.png"/>
  <figcaption>
</figcaption>
</figure>

where $e(t)$ is the error, $K_p$, $K_i$ and $K_d$ are the **proportional, integral and derivative parameters** respectively. The error value indicates the difference between the desired position, also called setpoint, and the current position of the motor. The goal of the controller is to minimize the error by adjusting the control variable $u(t)$. The **proportional term**, as the name suggests, changes the controller output in proportion to the error, so the bigger the error - the greater the control action. If a controller is using only the proportional term, meaning that the other ones are set to zero, the **end value will oscillate around the required position**, but depending on the parameter there might
always be an error. This problem is well known as the **steady-state error** and it can be minimized by the **integral term**. As long as the error is positive, the **integral term** will keep incrementing the rate of the control output, and otherwise - will be decrementing it, until the error is zero. The **derivative term** reacts to the **rate of change of the error**, meaning that once the error is being minimized with fast speed, the derivative term will gradually decrease the speed of the motor and **prevent it from passing over the desired position**. The three parameters of the PID controller **require tuning**, which is an important process, as the speed and the electric draw of the motors depend on them. Another term that can be used for **increasing the service life of the actuators and enhancing the controller’s efficacy** is the **deadband**. The **deadband** is a constant which is subtracted from the error value in order to limit the lower end of the voltage output. In other words, if the error value is smaller than the deadband, the error will be
set to 0 and the controller will stop the motors at that position. This approach **prevents the actuators from infinitely trying to reach a setpoint** to which they are very close, but cannot reach for some reason.